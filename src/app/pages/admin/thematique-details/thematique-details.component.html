<main class="table" id="customers_table">
  <section class="table__header">
    <h1> {{ 'admin.details.title' | translate:{ title: thematiqueTitre } }}</h1>
  </section>

  <div *ngIf="isLoading" class="spinner-container">
    <div class="loader"></div>
  </div>

  <section class="table__body">
    <table *ngIf="!isLoading">
      <thead>
        <tr>
          <th>{{ 'admin.details.subtheme' | translate }}</th>
          <th>{{ 'admin.details.question' | translate }}</th>
          <th (click)="sortTable('count')" [class.active]="sortColumn==='count'" [class.asc]="sortAsc">
            {{ 'admin.details.answersCount' | translate }}
            <span class="icon-arrow">&uarr;</span>
          </th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let st of sousThematiques">
          <tr *ngIf="!questionsMap[st.id]?.length">
            <td>{{ st.titre }}</td>
            <td colspan="2">{{ 'admin.details.noQuestion' | translate }}</td>
          </tr>

          <ng-container *ngIf="questionsMap[st.id]?.length">
            <tr>
              <td [attr.rowspan]="questionsMap[st.id].length">
                {{ st.titre }}
              </td>
              <td>
                {{ questionsMap[st.id][0].question }}
              </td>
              <td class="inline-actions">
                <span class="answers-count">
                  {{ responseCountMap[questionsMap[st.id][0].id] || 0 }}
                </span>

                <button class="btn btn-sm btn-outline-primary" (click)="goToQuestionDetails(questionsMap[st.id][0])">
                  {{ 'admin.details.view' | translate }}
                </button>

                <button class="btn btn-sm btn-outline-primary" (click)="openAnalysis(questionsMap[st.id][0])"
                  [disabled]="!(questionsMap[st.id][0].options?.length)">
                  {{ 'admin.details.analyze' | translate }}
                </button>
              </td>
            </tr>

            <tr *ngFor="let q of questionsMap[st.id]; let i = index" [hidden]="i === 0">
              <td>{{ q.question }}</td>
              <td class="inline-actions">
                <span class="answers-count">
                  {{ responseCountMap[q.id] || 0 }}
                </span>

                <button class="btn btn-sm btn-outline-primary" (click)="goToQuestionDetails(q)">
                  {{ 'admin.details.view' | translate }}
                </button>

                <button class="btn btn-sm btn-outline-primary" (click)="openAnalysis(q)"
                  [disabled]="!(q.options?.length)">
                  {{ 'admin.details.analyze' | translate }}
                </button>
              </td>
            </tr>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </section>

  <dialog #analysisDialog class="analysis-dialog">
    <button class="analysis-close" aria-label="Fermer" (click)="closeAnalysis()">Ã—</button>

    <h2 class="analysis-title">{{ 'admin.analysis.title' | translate }}</h2>

    <div class="analysis-subtitle">
      <strong>{{ 'admin.analysis.question' | translate }}</strong> {{ analysis.questionLabel || '' }}
    </div>

    <div *ngIf="analysis.loading" class="analysis-loading">
      <div class="spinner-border" role="status"><span class="visually-hidden">{{ 'generic.loading' | translate }}</span></div>
    </div>

    <ng-container *ngIf="!analysis.loading">
      <div class="analysis-chart">
        <app-barchart-analyse [labels]="analysis.options" [values]="analysis.counts"
          [title]="'admin.analysis.chartTitle' | translate">
        </app-barchart-analyse>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm analysis-table">
          <thead>
            <tr>
              <th>{{ 'admin.analysis.option' | translate }}</th>
              <th class="text-end">{{ 'admin.analysis.answers' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let opt of analysis.options; let i = index">
              <td>{{ opt }}</td>
              <td class="text-end">{{ analysis.counts[i] }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>
  </dialog>

</main>
