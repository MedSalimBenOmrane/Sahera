<main class="table" id="customers_table">
  <section class="table__header">
    <h1> Détails de la thématique « {{ thematiqueTitre }} »</h1>
  </section>

  <div *ngIf="isLoading" class="spinner-container">
    <div class="loader"></div>
  </div>

  <section class="table__body">
    <table *ngIf="!isLoading">
      <thead>
        <tr>
          <th>Sous-thématique</th>
          <th>Question</th>
          <th (click)="sortTable('count')" [class.active]="sortColumn==='count'" [class.asc]="sortAsc">
            Nombre de réponses
            <span class="icon-arrow">&uarr;</span>
          </th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let st of sousThematiques">
          <!-- pas de questions -->
          <tr *ngIf="!questionsMap[st.id]?.length">
            <td>{{ st.titre }}</td>
            <td colspan="2">Aucune question</td>
          </tr>

          <!-- avec questions -->
          <ng-container *ngIf="questionsMap[st.id]?.length">
            <!-- première ligne, cellule fusionnée -->
            <tr>
              <td [attr.rowspan]="questionsMap[st.id].length">
                {{ st.titre }}
              </td>
              <td>
                {{ questionsMap[st.id][0].question }}
              </td>
              <td class="inline-actions">
                <span class="answers-count">
                  {{ responseCountMap[questionsMap[st.id][0].id] || 0 }}
                </span>

                <button class="btn btn-sm btn-outline-primary" (click)="goToQuestionDetails(questionsMap[st.id][0])">
                  Voir Réponse
                </button>

                <button class="btn btn-sm btn-outline-primary" (click)="openAnalysis(questionsMap[st.id][0])"
                  [disabled]="!(questionsMap[st.id][0].options?.length)">
                  Analyser
                </button>
              </td>
            </tr>

            <!-- lignes suivantes de la même sous-thématique -->
            <tr *ngFor="let q of questionsMap[st.id]; let i = index" [hidden]="i === 0">
              <td>{{ q.question }}</td>
              <td class="inline-actions">
                <span class="answers-count">
                  {{ responseCountMap[q.id] || 0 }}
                </span>

                <button class="btn btn-sm btn-outline-primary" (click)="goToQuestionDetails(q)">
                  Voir Réponse
                </button>

                <button class="btn btn-sm btn-outline-primary" (click)="openAnalysis(q)"
                  [disabled]="!(q.options?.length)">
                  Analyser
                </button>
              </td>
            </tr>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </section>

  <!-- ========= MODAL D’ANALYSE ========= -->
  <!-- ========= MODAL D’ANALYSE ========= -->
  <dialog #analysisDialog class="analysis-dialog">
    <!-- Bouton X -->
    <button class="analysis-close" aria-label="Fermer" (click)="closeAnalysis()">❌</button>

    <!-- Titre -->
    <h2 class="analysis-title">Analyse des réponses</h2>

    <!-- Sous-titre (question) -->
    <div class="analysis-subtitle">
      <strong>Question :</strong> {{ analysis.questionLabel || '—' }}
    </div>

    <!-- Loader -->
    <div *ngIf="analysis.loading" class="analysis-loading">
      <div class="spinner-border" role="status"><span class="visually-hidden">Chargement…</span></div>
    </div>

    <!-- Contenu -->
    <ng-container *ngIf="!analysis.loading">
      <!-- Graphe -->
      <div class="analysis-chart">
        <app-barchart-analyse [labels]="analysis.options" [values]="analysis.counts"
          [title]="'Nombre de réponses par option'">
        </app-barchart-analyse>
      </div>

      <!-- Tableau de synthèse -->
      <div class="table-responsive mt-3">
        <table class="table table-sm analysis-table">
          <thead>
            <tr>
              <th>Option</th>
              <th class="text-end">Réponses</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let opt of analysis.options; let i = index">
              <td>{{ opt }}</td>
              <td class="text-end">{{ analysis.counts[i] }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>
  </dialog>

</main>